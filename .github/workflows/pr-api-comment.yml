name: Smart API Call
on:
  pull_request:
    types: [opened, synchronize]
jobs:
  analyze-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get optimized diff
        uses: actions/github-script@v7
        id: get-diff
        with:
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const targetFiles = files.data.filter(file => {
              // ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã¿
              const isSourceCode = /\.(js|ts|py|java|go|rs)$/.test(file.filename);
              // å¤‰æ›´ãŒå¤§ãã™ããªã„ã‚‚ã®
              const isReasonableSize = file.changes < 1000;
              // ãƒ‘ãƒƒãƒãŒå­˜åœ¨ã™ã‚‹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
              const hasPatch = file.patch !== undefined;
              
              return isSourceCode && isReasonableSize && hasPatch;
            });
            
            // æœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§
            return targetFiles.slice(0, 10).map(f => ({
              filename: f.filename,
              diff: f.patch
            }));
          result-encoding: string
          
      - name: Call API with filtered data
        id: api-call
        run: |
          # å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’contentãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ãƒ©ãƒƒãƒ—
          body=$(jq -n --arg content '${{ steps.get-diff.outputs.result }}' '{content: $content}')
          
          response=$(curl -s -X POST ${{ secrets.API_ENDPOINT }} \
            -H "Content-Type: application/json" \
            -d "$body")
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜ï¼ˆè¤‡æ•°è¡Œå¯¾å¿œï¼‰
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$response" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Comment API response on PR
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.api-call.outputs.response }}`;
            
            // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆ
            const commentBody = '## ğŸ¤– API Analysis Result\n\n```json\n' + response + '\n```\n\n---\n\n*Generated by GitHub Actions*';
            
            // PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });